name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CLAMAV_SOCKET: /var/run/clamav/clamd.ctl

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.26"
          cache: true
          cache-dependency-path: src/go.sum

      - name: Install Protocol Buffers compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Generate Proto Files
        run: |
          ./scripts/generate-proto.sh

      - name: Install and start ClamAV
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav clamav-daemon socat

          sudo mkdir -p /var/log/clamav /var/run/clamav
          sudo chown -R clamav:clamav /var/log/clamav /var/run/clamav
          sudo chmod -R 777 /var/log/clamav /var/run/clamav

          # Stop freshclam if running (conflicts with manual invocation)
          sudo systemctl stop clamav-freshclam 2>/dev/null || true

          # Update virus database
          sudo freshclam --stdout || echo "freshclam update failed, continuing with bundled DB..."

          # Start clamd in the background
          sudo clamd &

          # Wait for the socket to exist AND clamd to respond to PING
          echo "Waiting for ClamAV daemon to be ready..."
          for i in $(seq 1 120); do
            if [ -S "$CLAMAV_SOCKET" ]; then
              if echo PING | socat - UNIX-CONNECT:"$CLAMAV_SOCKET" 2>/dev/null | grep -q PONG; then
                echo "ClamAV is ready and responding after ${i}s"
                break
              fi
            fi
            if [ $((i % 10)) -eq 0 ]; then
              echo "Still waiting for ClamAV... (${i}/120s)"
            fi
            sleep 1
          done

          # Final verification
          if ! echo PING | socat - UNIX-CONNECT:"$CLAMAV_SOCKET" 2>/dev/null | grep -q PONG; then
            echo "ERROR: ClamAV daemon is not responding"
            ps aux | grep clamd || true
            ls -la /var/run/clamav/ || true
            exit 1
          fi

          echo "ClamAV daemon verified and responding"

      - name: Update Go dependencies
        run: |
          cd src
          go mod tidy

      - name: Run all tests
        run: |
          cd src
          go test -v -race ./... -coverprofile=coverage.txt

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./src/coverage.txt
          flags: unittests
